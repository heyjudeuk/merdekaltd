<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>ALIBRA SHIPPING WEEKLY TIME CHARTER RATES</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1a2e;
      --panel2: #0c1628;
      --text: #e6edf6;
      --muted: #9db0c7;
      --grid: rgba(157, 176, 199, 0.16);
      --border: rgba(157, 176, 199, 0.14);
      --shadow: rgba(0, 0, 0, 0.22);

      --accent: #7aa2ff;
      --accentFill: rgba(122, 162, 255, 0.18);

      --pos: #4ade80;
      --neg: #fb7185;
      --neu: #a3b3c7;
      --divider: rgba(157, 176, 199, 0.4);
    }

    /* Global sizing + iOS/Edge(iOS) text autosizing guard */
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    html {
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }



    canvas {
      display: block;
      max-width: 100%;
    }

    /* Default chart canvas sizing (prevents responsive height feedback loops on iOS) */
    .card canvas {
      width: 100% !important;
      height: 260px !important;
    }

    /* Forward-curve charts manage their own height via .fcChartBox */
    .fcChartBox canvas {
      height: 100% !important;
    }


    body {
      margin: 0;
      padding: 18px;
      background: radial-gradient(1200px 600px at 15% 0%, #111f3a 0%, var(--bg) 60%);
      color: var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    header {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin-bottom: 18px;
      text-align: center;
    }

    header::after {
      content: "";
      display: block;
      width: 140px;
      height: 1px;
      margin-top: 8px;
      background: linear-gradient(90deg,
          transparent,
          var(--divider),
          transparent);
    }



    h1 {
      margin: 0;
      font-size: 22px;
      letter-spacing: 0.6px;
      font-weight: 750;
      color: var(--text);
      text-transform: uppercase;
    }


    .sub {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }

    .status {
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      color: var(--muted);
      font-size: 13px;
      margin-bottom: 14px;
    }

    .status {
      margin-top: 20px;
      /* breathing space from charts */
      margin-bottom: 24px;
    }


    .grid {
      display: grid;
      gap: 14px;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: repeat(auto-fill, minmax(420px, 1fr));
      }
    }

    .card {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px 14px 12px 14px;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      box-shadow: 0 10px 30px var(--shadow);
    }

    .titleRow {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .title {
      margin: 0;
      font-size: 13px;
      font-weight: 650;
      color: var(--text);
      line-height: 1.2;
    }

    .meta {
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap;
    }

    .metrics {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (min-width: 520px) {
      .metrics {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .pill {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(255, 255, 255, 0.03);
    }

    .pill .k {
      color: var(--muted);
      font-size: 11px;
      letter-spacing: 0.25px;
      text-transform: uppercase;
      margin-bottom: 6px;
    }

    .pill .v {
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      line-height: 1.2;
      word-break: break-word;
    }

    .v.pos {
      color: var(--pos);
    }

    .v.neg {
      color: var(--neg);
    }

    .error {
      border-color: rgba(255, 90, 122, 0.35);
      background: rgba(255, 90, 122, 0.10);
      color: #ffd2dc;
    }

    .tableCard {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
    }

    .tableTitle {
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 650;
      color: var(--text);
    }


    .tableNote {
      margin: -6px 0 10px 0;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.3;
    }

    .tableWrap {
      overflow-x: auto;
      /* allow horizontal scroll on very narrow screens */
      -webkit-overflow-scrolling: touch;
      border-radius: 12px;
      border: 1px solid var(--border);
      margin-bottom: 10px;
      /* space before footnotes */
    }

    .tableFootnote {
      margin: 0;
      padding-top: 8px;
      color: var(--muted);
      font-size: 11px;
      line-height: 1.3;
    }

    .tceTable {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: rgba(255, 255, 255, 0.02);
    }

    .tceTable th,
    .tceTable td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border);
      text-align: right;
      font-size: 12px;
    }

    .tceTable th {
      background: rgba(255, 255, 255, 0.04);
      color: var(--muted);
      font-weight: 650;
    }

    .periodSeparator {
      border-right: 1px solid var(--divider) !important;
    }

    .tceTable thead tr:nth-child(1) th {
      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
    }

    .tceTable th:first-child,
    .tceTable td:first-child {
      text-align: left;
      position: sticky;
      left: 0;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);
      z-index: 2;
      border-right: 1px solid var(--divider);
    }

    .tceTable thead th:first-child {
      z-index: 3;
    }

    .markerCol {
      width: 1ch;
      padding-right: 2px !important;
      padding-left: 8px !important;
      text-align: right !important;
      font-size: 11px;
      line-height: 1;
      white-space: nowrap;
    }

    .markerCol+td {
      padding-left: 4px !important;
      padding-right: 12px !important;
      text-align: left !important;
      white-space: nowrap;
    }

    .pos {
      color: var(--pos);
      font-weight: 700;
    }

    .neg {
      color: var(--neg);
      font-weight: 700;
    }

    .neu {
      color: #ffd54a;
      font-weight: 700;
    }

    .cellSubtle {
      color: var(--muted);
      font-weight: 600;
    }

    .tablesGrid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    @media (min-width: 1100px) {
      .tablesGrid {
        grid-template-columns: 1fr 1fr;
      }
    }

    .periodHeader {
      text-align: center !important;
      letter-spacing: 0.4px;
    }

    .markerUp {
      color: var(--pos);
      font-weight: 800;
    }

    .markerDown {
      color: var(--neg);
      font-weight: 800;
    }

    /* Ensure cards never exceed their grid column on iOS/WebKit */
    .card,
    .tableCard {
      max-width: 100%;
    }

    .tableCard {
      overflow: hidden;
    }

    .tableWrap {
      width: 100%;
      max-width: 100%;
    }

    /* Forward-curve only wrapper to keep Chart.js sizing accurate */
    .fcChartBox {
      height: 260px;
      width: 100%;
      position: relative;
    }

    .fcChartBox canvas {
      width: 100% !important;
      height: 100% !important;
      display: block;
    }

    /* =========================
   DRY BULK TABLE GREEN THEME
   ========================= */

    .dryBulk .tceTable thead th {
      background: rgba(74, 222, 128, 0.18);
      /* soft green */
      color: #eafff1;
    }

    .dryBulk .tceTable thead tr:nth-child(1) th {
      background: rgba(74, 222, 128, 0.25);
      /* stronger for PERIOD row */
    }

    .dryBulk .tceTable th {
      border-bottom-color: rgba(74, 222, 128, 0.35);
    }

    .dryBulk .periodSeparator {
      border-right-color: rgba(74, 222, 128, 0.45) !important;
    }

    /* =========================
   DRY BULK CHART GREEN CARDS
   ========================= */

    .dryBulkChart {
      background: linear-gradient(180deg,
          rgba(74, 222, 128, 0.14) 0%,
          rgba(15, 26, 46, 0.95) 65%);
      border-color: rgba(74, 222, 128, 0.35);
    }

    .dryBulkChart .title {
      color: #d1fae5;
    }

    /* =========================
   TANKER TABLE BLUE THEME
   ========================= */

    .tanker .tceTable thead th {
      background: rgba(96, 165, 250, 0.22);
      /* brighter blue */
      color: #eef4ff;
    }

    .tanker .tceTable thead tr:nth-child(1) th {
      background: rgba(96, 165, 250, 0.30);
      /* stronger PERIOD row */
    }

    .tanker .tceTable th {
      border-bottom-color: rgba(96, 165, 250, 0.45);
    }

    .tanker .periodSeparator {
      border-right-color: rgba(96, 165, 250, 0.55) !important;
    }

    /* =========================
   TANKER CHART BLUE CARDS
   ========================= */

    .tankerChart {
      background: linear-gradient(180deg,
          rgba(96, 165, 250, 0.16) 0%,
          rgba(15, 26, 46, 0.95) 65%);
      border-color: rgba(96, 165, 250, 0.40);
    }

    .tankerChart .title {
      color: #dbeafe;
    }

    /* =========================
   SECTION HEADERS (MATCH MAIN HEADER)
   ========================= */

    .sectionHeader {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      margin: 18px 0 18px;
      text-align: center;
    }

    .sectionTitle {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.6px;
      font-weight: 750;
      color: var(--text);
      text-transform: uppercase;
    }

    /* Divider line – same as main header */
    .sectionHeader::after {
      content: "";
      display: block;
      width: 140px;
      height: 1px;
      margin-top: 8px;
      background: linear-gradient(90deg,
          transparent,
          var(--divider),
          transparent);
    }

    .sectionTitle {
      font-size: 19px;
      opacity: 0.95;
    }

    /* =========================
   FORWARD CURVE AMBER CARDS
   ========================= */

    .forwardCurve {
      background: linear-gradient(180deg,
          rgba(250, 204, 21, 0.16) 0%,
          rgba(15, 26, 46, 0.95) 65%);
      border-color: rgba(250, 204, 21, 0.45);
    }

    .forwardCurve .title {
      color: #fde68a;
    }

    /* =========================
   FORWARD CURVE AMBER PILLS
   ========================= */

    .forwardCurve .pill {
      border-color: rgba(250, 204, 21, 0.40);
      background: rgba(250, 204, 21, 0.08);
    }

    .forwardCurve .pill .k {
      color: #fde68a;
      /* warm label */
      opacity: 0.95;
    }

    .forwardCurve .pill .v {
      color: #fff7d6;
      /* readable value */
    }

    .forwardCurve .v.neu {
      color: #fde68a;
    }

    .markerFlat {
      font-weight: 700;
      opacity: 0.9;
    }

    /* =========================
   FLAT / NO-CHANGE MARKER
   ========================= */

    .markerFlat {
      color: #facc15;
      /* amber / yellow */
      font-weight: 700;
      opacity: 0.9;
    }
  </style>
</head>

<body>

  <header>
    <div>
      <h1>ALIBRA SHIPPING WEEKLY TIME CHARTER RATES</h1>
    </div>
    <div class="sub" id="lastUpdated"></div>
  </header>

  <div id="tceTables" class="tablesGrid" style="margin-bottom:14px;"></div>

  <div id="dryBulkTrends" class="tablesGrid" style="margin-bottom:14px;"></div>

  <div id="tankerTables" class="tablesGrid" style="margin-bottom:14px;"></div>

  <div id="tankerTrends" class="tablesGrid" style="margin-bottom:14px;"></div>

  <section class="sectionHeader">
    <h2 class="sectionTitle">
      FORWARD CURVES: SHIP TYPES (USD/DAY)
    </h2>
    <div class="sub">Tenors are 3 months apart.</div>
  </section>

  <div id="charts" class="grid"></div>

  <div id="status" class="status">Loading…</div>

  <script>
    // URL Constants
    const TABLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk6073LStJEfzv418WKYluN2zykXon3KL58hPVNnqoOPiZVhBVzBCi9QnnAETwm_QbMvltcNCuzTzH/pub?gid=1944138367&single=true&output=csv";
    const FORWARD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRdqAGPK_OWDdd7rIBkTtSk2WG4k7Rgth9rTbkN9KR6U74OXO8kq-QOmiAVIo1ZtA/pub?gid=1196769730&single=true&output=csv";
    const TREND_ATL_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm3hFo3WpdJQ86FaGIy-S151biJvr2J31-kbmYmO9kOwJ2sDjbz-v8ooNpsufCepZS0tCUavO5iUrI/pub?gid=409746990&single=true&output=csv";
    const TREND_PAC_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm3hFo3WpdJQ86FaGIy-S151biJvr2J31-kbmYmO9kOwJ2sDjbz-v8ooNpsufCepZS0tCUavO5iUrI/pub?gid=779118968&single=true&output=csv";
    const LAST_UPDATED_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk6073LStJEfzv418WKYluN2zykXon3KL58hPVNnqoOPiZVhBVzBCi9QnnAETwm_QbMvltcNCuzTzH/pub?gid=92942855&single=true&output=csv";

    // Tanker Tables (Weekly TCE snapshot)
    const TANKER_TABLE_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQk6073LStJEfzv418WKYluN2zykXon3KL58hPVNnqoOPiZVhBVzBCi9QnnAETwm_QbMvltcNCuzTzH/pub?gid=1458966001&single=true&output=csv";

    // Tanker Trend Charts (Annual)
    const TANKER_TREND_1Y_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm3hFo3WpdJQ86FaGIy-S151biJvr2J31-kbmYmO9kOwJ2sDjbz-v8ooNpsufCepZS0tCUavO5iUrI/pub?gid=137918187&single=true&output=csv";
    const TANKER_TREND_5Y_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSm3hFo3WpdJQ86FaGIy-S151biJvr2J31-kbmYmO9kOwJ2sDjbz-v8ooNpsufCepZS0tCUavO5iUrI/pub?gid=2023480649&single=true&output=csv";

    const statusEl = document.getElementById("status");
    const chartsEl = document.getElementById("charts");
    const lastUpdatedEl = document.getElementById("lastUpdated");
    const dryBulkTrendsEl = document.getElementById("dryBulkTrends");
    const tankerTrendsEl = document.getElementById("tankerTrends");

    // Distinct, non-orange palette for tanker series
    const DISTINCT_PALETTE = [
      "#4E79A7", // blue
      "#E15759", // red
      "#76B7B2", // teal
      "#59A14F", // green
      "#EDC948", // yellow
      "#B07AA1", // purple
      "#9C755F", // brown
      "#FF9DA7", // pink
      "#BAB0AC"  // grey
    ];

    // Build a per-chart colour map so no series repeats a colour
    function buildSeriesColorMap(keys) {
      const map = {};
      const used = new Set();

      // 1) Hard rules first
      keys.forEach(k => {
        const name = String(k || "");
        if (/^vlcc$/i.test(name)) {
          map[k] = "#fb923c"; // VLCC orange (stronger than palette orange)
          used.add(map[k]);
        }
      });

      // 2) Assign remaining series unique colours from the palette
      let i = 0;
      keys.forEach(k => {
        if (map[k]) return;
        while (i < DISTINCT_PALETTE.length && used.has(DISTINCT_PALETTE[i])) i++;
        const c = DISTINCT_PALETTE[i % DISTINCT_PALETTE.length];
        map[k] = c;
        used.add(c);
        i++;
      });

      return map;
    }


    function setStatus(msg, isError = false) {
      statusEl.textContent = msg;
      statusEl.className = "status" + (isError ? " error" : "");
    }

    function getCss(varName) {
      return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
    }

    function fmtUSD(n) {
      if (n === null || n === undefined) return "—";
      return new Intl.NumberFormat("en-GB", { maximumFractionDigits: 0 }).format(n);
    }

    function fmtGBPishNumber(n) {
      if (n === null || n === undefined) return "—";
      return new Intl.NumberFormat("en-GB", { maximumFractionDigits: 0 }).format(n);
    }

    function fmtSignedUSD(n) {
      if (n === null || n === undefined) return "—";
      const sign = n > 0 ? "+" : (n < 0 ? "−" : "");
      return sign + fmtUSD(Math.abs(n));
    }

    function parseMoneyCell(x) {
      const s = String(x ?? "").trim().replace(/^"+|"+$/g, "").replace(/,/g, "");
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function parsePctCell(x) {
      const s = String(x ?? "").trim().replace(/^"+|"+$/g, "");
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    function toNumber(x) {
      const s = String(x ?? "").trim().replace(/^"+|"+$/g, "").replace(/,/g, "");
      if (!s) return null;
      const n = Number(s);
      return Number.isFinite(n) ? n : null;
    }

    // Helper to generate marker/arrow cells
    function markerCell(change) {
      const td = document.createElement("td");
      td.className = "markerCol";

      if (change === null || change === undefined) {
        td.textContent = "";
        return td;
      }

      if (change > 0) {
        td.textContent = "▲";
        td.classList.add("markerUp");
        return td;
      }

      if (change < 0) {
        td.textContent = "▼";
        td.classList.add("markerDown");
        return td;
      }

      // change === 0 → no change
      td.textContent = "—";
      td.classList.add("markerFlat");
      return td;
    }


    function finite(arr) { return arr.filter(v => typeof v === "number" && Number.isFinite(v)); }
    function firstFinite(arr) {
      for (const v of arr) if (typeof v === "number" && Number.isFinite(v)) return v;
      return null;
    }
    function lastFinite(arr) {
      for (let i = arr.length - 1; i >= 0; i--) {
        const v = arr[i];
        if (typeof v === "number" && Number.isFinite(v)) return v;
      }
      return null;
    }
    function lastStepDelta(arr) {
      let last = null;
      for (let i = arr.length - 1; i >= 0; i--) {
        const v = arr[i];
        if (typeof v === "number" && Number.isFinite(v)) {
          if (last === null) last = v;
          else return last - v;
        }
      }
      return null;
    }
    function minMax(arr) {
      const xs = finite(arr);
      if (!xs.length) return { min: null, max: null };
      let min = xs[0], max = xs[0];
      for (const v of xs) { if (v < min) min = v; if (v > max) max = v; }
      return { min, max };
    }
    function avgSlopePerStep(arr) {
      const xs = finite(arr);
      if (xs.length < 2) return null;
      return (xs[xs.length - 1] - xs[0]) / (xs.length - 1);
    }
    function cls(n) {
      if (n === null || n === undefined) return "neu";
      if (n > 0) return "pos";
      if (n < 0) return "neg";
      return "neu";
    }

    function pill(key, value, colorClass = "neu") {
      const p = document.createElement("div");
      p.className = "pill";
      const k = document.createElement("div");
      k.className = "k";
      k.textContent = key;
      const v = document.createElement("div");
      v.className = "v " + colorClass;
      v.textContent = value;
      p.appendChild(k);
      p.appendChild(v);
      return p;
    }

    // --- RENDER TABLES ---

    // --- RENDER DRY BULK TABLES (SPLIT ATL/PAC) ---
    function renderTwoTables(tableRows) {
      const host = document.getElementById("tceTables");
      if (!host) return;
      host.innerHTML = "";

      tableRows.sort((a, b) => (a.SORT ?? 999) - (b.SORT ?? 999));
      const sizes = tableRows.map(r => r.Size);

      const periods = [
        { label: "4-6 Months", val: "6Months", chg: "6Mchange" },
        { label: "1 Year", val: "1Year", chg: "1YRchange" },
        { label: "2 Year", val: "2Year", chg: "2YRchange" },
      ];

      function makeOceanTableCard(title, ocean, mode) {
        // mode: "rate" | "pct"
        const card = document.createElement("div");
        card.className = "tableCard dryBulk";

        const h = document.createElement("h3");
        h.className = "tableTitle";
        h.textContent = title;
        card.appendChild(h);

        const wrap = document.createElement("div");
        wrap.className = "tableWrap";

        const table = document.createElement("table");
        table.className = "tceTable";

        const thead = document.createElement("thead");

        const r1 = document.createElement("tr");
        r1.appendChild(Object.assign(document.createElement("th"), { className: "periodSeparator", textContent: "PERIOD" }));
        periods.forEach((p, idx) => {
          const th = document.createElement("th");
          th.colSpan = 2;
          th.className = "periodHeader" + (idx < periods.length - 1 ? " periodSeparator" : "");
          th.textContent = p.label;
          r1.appendChild(th);
        });
        thead.appendChild(r1);

        const r2 = document.createElement("tr");
        r2.appendChild(Object.assign(document.createElement("th"), { className: "periodSeparator", textContent: "SIZE" }));
        periods.forEach((p, idx) => {
          const th = document.createElement("th");
          th.colSpan = 2;
          th.style.textAlign = "left";
          th.style.paddingLeft = "8px";
          th.textContent = (mode === "rate") ? "Rate" : "% Change";
          if (idx < periods.length - 1) th.classList.add("periodSeparator");
          r2.appendChild(th);
        });
        thead.appendChild(r2);

        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        sizes.forEach((size, idx) => {
          const row = tableRows[idx];
          const tr = document.createElement("tr");
          tr.appendChild(Object.assign(document.createElement("td"), { textContent: size }));

          periods.forEach((p, i) => {
            const valKey = p.val + ocean; // e.g. 1YearATL
            const chgKey = p.chg + ocean; // e.g. 1YRchangeATL
            const chg = parsePctCell(row[chgKey]);

            tr.appendChild(markerCell(chg));

            const td = document.createElement("td");
            if (mode === "rate") {
              const v = parseMoneyCell(row[valKey]);
              td.textContent = v === null ? "—" : `$${fmtGBPishNumber(v)}`;
            } else {
              td.textContent = (chg === null) ? "—" : `${chg}%`;
            }

            if (i < periods.length - 1) td.classList.add("periodSeparator");
            tr.appendChild(td);
          });

          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        wrap.appendChild(table);
        card.appendChild(wrap);



        return card;
      }

      // Rates
      host.appendChild(makeOceanTableCard("DRY BULK TIME CHARTER ESTIMATES: ATLANTIC (USD/DAY PRO RATA)", "ATL", "rate"));
      host.appendChild(makeOceanTableCard("DRY BULK TIME CHARTER ESTIMATES: PACIFIC (USD/DAY PRO RATA)", "PAC", "rate"));

      // % Change
      host.appendChild(makeOceanTableCard("DRY BULK TIME CHARTER ESTIMATES: ATLANTIC (% CHANGE FROM PREVIOUS WEEK)", "ATL", "pct"));
      host.appendChild(makeOceanTableCard("DRY BULK TIME CHARTER ESTIMATES: PACIFIC (% CHANGE FROM PREVIOUS WEEK)", "PAC", "pct"));
    }


    // --- RENDER TANKER TABLES (NEW) ---
    function renderTankerTables(tableRows) {
      const host = document.getElementById("tankerTables");
      if (!host) return;

      tableRows.sort((a, b) => (a.SORT ?? 999) - (b.SORT ?? 999));

      // Detect year periods from headers (e.g. 1Year, 3Year, 5Year, 1YR, 3YR, 5YR)
      const sample = tableRows[0] || {};
      const keys = Object.keys(sample);

      function normaliseKey(k) { return String(k || "").toLowerCase().replace(/\s+/g, ""); }
      function extractYearNum(k) {
        const s = normaliseKey(k);
        // match 1year / 1yr / year1
        let m = s.match(/^(\d+)(year|yr)$/);
        if (m) return Number(m[1]);
        m = s.match(/^(\d+)(year|yr)/);
        if (m) return Number(m[1]);
        m = s.match(/(year|yr)(\d+)/);
        if (m) return Number(m[2]);
        return null;
      }
      function isChangeKey(k) {
        const s = normaliseKey(k);
        return s.includes("change") || s.includes("%") || s.includes("pct");
      }

      // Value keys: year keys that are NOT change keys
      const yearValueKeys = keys
        .map(k => ({ k, yr: extractYearNum(k), isChg: isChangeKey(k) }))
        .filter(o => o.yr !== null && !o.isChg)
        .sort((a, b) => a.yr - b.yr);

      // For each year, find a matching change key
      const periods = yearValueKeys.map(o => {
        const yr = o.yr;
        const base = String(yr);
        const chg = keys.find(k => {
          const s = normaliseKey(k);
          return isChangeKey(k) && (s.includes(base + "year") || s.includes(base + "yr") || s.includes("year" + base) || s.includes("yr" + base));
        }) || null;

        return { yr, label: yr + " Y" + ((yr === 3 || yr === 5) ? "*" : ""), valKey: o.k, chgKey: chg };
      });

      function makeTableCard(title, makeBodyFn) {
        const card = document.createElement("div");
        card.className = "tableCard tanker";

        const h = document.createElement("h3");
        h.className = "tableTitle";
        h.textContent = title;
        card.appendChild(h);


        const wrap = document.createElement("div");
        wrap.className = "tableWrap";

        const table = document.createElement("table");
        table.className = "tceTable";

        const thead = document.createElement("thead");

        const r1 = document.createElement("tr");
        r1.appendChild(Object.assign(document.createElement("th"), { className: "periodSeparator", textContent: "PERIOD" }));
        periods.forEach((p, idx) => {
          const th = document.createElement("th");
          th.colSpan = 2;
          th.className = "periodHeader" + (idx < periods.length - 1 ? " periodSeparator" : "");
          th.textContent = p.label;
          r1.appendChild(th);
        });
        thead.appendChild(r1);

        const r2 = document.createElement("tr");
        r2.appendChild(Object.assign(document.createElement("th"), { className: "periodSeparator", textContent: "SIZE" }));
        periods.forEach((p, idx) => {
          const th = document.createElement("th");
          th.colSpan = 2;
          th.style.textAlign = "left";
          th.style.paddingLeft = "8px";
          th.textContent = "Rate";
          if (idx < periods.length - 1) th.classList.add("periodSeparator");
          r2.appendChild(th);
        });
        thead.appendChild(r2);

        table.appendChild(thead);

        const tbody = document.createElement("tbody");
        tableRows.forEach(row => {
          const tr = document.createElement("tr");
          tr.appendChild(Object.assign(document.createElement("td"), { textContent: row.Size ?? row.SIZE ?? row.size ?? "" }));

          const cells = makeBodyFn(row);
          cells.forEach(td => tr.appendChild(td));
          tbody.appendChild(tr);
        });

        table.appendChild(tbody);
        wrap.appendChild(table);
        card.appendChild(wrap);

        const foot = document.createElement("p");
        foot.className = "tableFootnote";
        foot.textContent = "* Eco tonnage with Scrubber fitted.";
        card.appendChild(foot);

        return card;
      }

      const table1 = makeTableCard("TANKER TIME CHARTER ESTIMATES (USD/DAY PRO RATA)", (row) => {
        const tds = [];
        periods.forEach((p, i) => {
          const val = parseMoneyCell(row[p.valKey]);
          const chg = p.chgKey ? parsePctCell(row[p.chgKey]) : null;

          tds.push(markerCell(chg));

          const td = document.createElement("td");
          td.textContent = val === null ? "—" : `$${fmtGBPishNumber(val)}`;
          if (i < periods.length - 1) td.classList.add("periodSeparator");
          tds.push(td);
        });
        return tds;
      });

      const table2 = makeTableCard("TANKER TIME CHARTER ESTIMATES (% CHANGE FROM PREVIOUS WEEK)", (row) => {
        const tds = [];
        periods.forEach((p, i) => {
          const pct = p.chgKey ? parsePctCell(row[p.chgKey]) : null;

          tds.push(markerCell(pct));

          const td = document.createElement("td");
          td.textContent = (pct === null) ? "—" : `${pct}%`;
          if (i < periods.length - 1) td.classList.add("periodSeparator");
          tds.push(td);
        });
        return tds;
      });

      host.appendChild(table1);
      host.appendChild(table2);
    }


    // --- RENDER TREND CHARTS (NEW) ---

    async function renderDryBulkTrendCharts() {
      const [atlRes, pacRes] = await Promise.all([
        fetch(TREND_ATL_URL),
        fetch(TREND_PAC_URL)
      ]);

      if (!atlRes.ok) throw new Error("Failed to load Atlantic Trend CSV");
      if (!pacRes.ok) throw new Error("Failed to load Pacific Trend CSV");

      const atlText = await atlRes.text();
      const pacText = await pacRes.text();

      const atlData = Papa.parse(atlText, { header: true, skipEmptyLines: true }).data;
      const pacData = Papa.parse(pacText, { header: true, skipEmptyLines: true }).data;

      function createTrendCard(title, dataRows) {
        const card = document.createElement("div");
        card.className = "card dryBulkChart";

        const titleRow = document.createElement("div");
        titleRow.className = "titleRow";
        const h = document.createElement("div");
        h.className = "title";
        h.textContent = title;
        titleRow.appendChild(h);
        card.appendChild(titleRow);

        const canvas = document.createElement("canvas");
        card.appendChild(canvas);
        dryBulkTrendsEl.appendChild(card);

        const keys = Object.keys(dataRows[0]);
        const dateKey = keys[0];
        const shipKeys = keys.slice(1);

        const labels = dataRows.map(r => r[dateKey]);

        const colorMap = buildSeriesColorMap(shipKeys);


        const datasets = shipKeys.map((key, i) => ({
          // 1. ADD SPACES HERE for the gap between circle and text
          label: "  " + key + "  ",
          data: dataRows.map(r => toNumber(r[key])),
          borderColor: colorMap[key],
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 4,
          pointHitRadius: 10
        }));

        new Chart(canvas, {
          type: 'line',
          data: {
            labels: labels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false,
            },
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: getCss("--muted"),
                  font: { size: 11 },
                  /* 1. Ensure this is false to use the rectangular box style */
                  usePointStyle: false,
                  /* 2. Set boxWidth and boxHeight to the same value for solid squares */
                  boxWidth: 8,
                  boxHeight: 8,
                  /* 3. Padding adds space between the legend items */
                  padding: 20
                }
              },
              tooltip: {
                enabled: true,
                padding: 12,
                titleFont: { size: 13 },
                bodyFont: { size: 13 },
                usePointStyle: false, // Keeps the indicator as a box
                callbacks: {
                  label: (ctx) => ` ${ctx.dataset.label.trim()}: $${fmtUSD(ctx.parsed.y)}`,

                  // Set the box to a solid color matching the line
                  labelColor: function (context) {
                    return {
                      // Sets the border to the line color
                      borderColor: context.dataset.borderColor,
                      // Sets the fill to the same color as the line
                      backgroundColor: context.dataset.borderColor,
                      borderWidth: 1,
                      borderRadius: 2
                    };
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: getCss("--grid") },
                ticks: {
                  maxTicksLimit: 8,
                  maxRotation: 0
                }
              },
              y: {
                grid: { color: getCss("--grid") },
                ticks: { callback: (val) => "$" + fmtUSD(val) },
                title: { display: true, text: "USD/day" }
              }
            }
          }
        });
      }

      createTrendCard("DRY BULK 1YR TC RATES: ATLANTIC ANNUAL TREND", atlData);
      createTrendCard("DRY BULK 1YR TC RATES: PACIFIC ANNUAL TREND", pacData);
    }

    // --- RENDER TANKER TREND CHARTS (NEW) ---
    async function renderTankerTrendCharts() {
      const [oneRes, fiveRes] = await Promise.all([
        fetch(TANKER_TREND_1Y_URL),
        fetch(TANKER_TREND_5Y_URL)
      ]);

      if (!oneRes.ok) throw new Error("Failed to load Tanker 1Y Trend CSV");
      if (!fiveRes.ok) throw new Error("Failed to load Tanker 5Y Trend CSV");

      const oneText = await oneRes.text();
      const fiveText = await fiveRes.text();

      const oneData = Papa.parse(oneText, { header: true, skipEmptyLines: true }).data;
      const fiveData = Papa.parse(fiveText, { header: true, skipEmptyLines: true }).data;

      function createTankerTrendCard(title, dataRows) {
        const card = document.createElement("div");
        card.className = "card tankerChart";

        const titleRow = document.createElement("div");
        titleRow.className = "titleRow";
        const h = document.createElement("div");
        h.className = "title";
        h.textContent = title;
        titleRow.appendChild(h);
        card.appendChild(titleRow);

        const canvas = document.createElement("canvas");
        card.appendChild(canvas);
        tankerTrendsEl.appendChild(card);

        if (!dataRows || !dataRows.length) return;

        const keys = Object.keys(dataRows[0]);
        const dateKey = keys[0];
        const shipKeys = keys.slice(1);
        const colorMap = buildSeriesColorMap(shipKeys);


        const labels = dataRows.map(r => r[dateKey]);

        const datasets = shipKeys.map((key, i) => ({
          label: "  " + key + "  ",
          data: dataRows.map(r => toNumber(r[key])),
          borderColor: colorMap[key],
          backgroundColor: 'transparent',
          borderWidth: 2,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 4,
          pointHitRadius: 10
        }));

        new Chart(canvas, {
          type: 'line',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                labels: {
                  color: getCss("--muted"),
                  font: { size: 11 },
                  usePointStyle: false,
                  boxWidth: 8,
                  boxHeight: 8,
                  padding: 20
                }
              },
              tooltip: {
                enabled: true,
                padding: 12,
                titleFont: { size: 13 },
                bodyFont: { size: 13 },
                usePointStyle: false,
                callbacks: {
                  label: (ctx) => ` ${ctx.dataset.label.trim()}: $${fmtUSD(ctx.parsed.y)}`,
                  labelColor: (context) => ({
                    borderColor: context.dataset.borderColor,
                    backgroundColor: context.dataset.borderColor,
                    borderWidth: 1,
                    borderRadius: 2
                  })
                }
              }
            },
            scales: {
              x: {
                grid: { color: getCss("--grid") },
                ticks: { maxTicksLimit: 8, maxRotation: 0 }
              },
              y: {
                grid: { color: getCss("--grid") },
                ticks: { callback: (val) => "$" + fmtUSD(val) },
                title: { display: true, text: "USD/day" }
              }
            }
          }
        });
      }

      createTankerTrendCard("TANKER 1YR TC RATES ANNUAL TREND", oneData);
      createTankerTrendCard("TANKER 5YR TC RATES ANNUAL TREND", fiveData);
    }

    async function loadLastUpdatedFromSheet() {
      const res = await fetch(LAST_UPDATED_CSV_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("Last-updated CSV fetch failed");

      const text = await res.text();

      // Single-cell CSV: value will be in first row, first column
      const parsed = Papa.parse(text, { skipEmptyLines: true });
      const value = parsed?.data?.[0]?.[0];

      return String(value ?? "").trim();
    }




    // --- MAIN INIT ---
    async function init() {
      try {
        Chart.defaults.color = getCss("--muted");

        // 1. Render Tables
        const tRes = await fetch(TABLE_CSV_URL, { cache: "no-store" });
        if (!tRes.ok) throw new Error(`Table CSV fetch failed`);
        const tText = await tRes.text();
        const tParsed = Papa.parse(tText, { header: true, skipEmptyLines: true });
        const tRows = (tParsed.data || []).map(r => ({ ...r, SORT: Number(String(r.SORT ?? "").trim()) }));
        renderTwoTables(tRows);

        // 2. Render Dry Bulk Trend Charts
        await renderDryBulkTrendCharts();

        // 3. Render Tanker Tables
        const tkRes = await fetch(TANKER_TABLE_CSV_URL, { cache: "no-store" });
        if (!tkRes.ok) throw new Error(`Tanker Table CSV fetch failed`);
        const tkText = await tkRes.text();
        const tkParsed = Papa.parse(tkText, { header: true, skipEmptyLines: true });
        const tkRows = (tkParsed.data || []).map(r => ({ ...r, SORT: Number(String(r.SORT ?? "").trim()) }));
        renderTankerTables(tkRows);

        // 4. Render Tanker Trend Charts
        await renderTankerTrendCharts();

        // 5. Render Forward Curves (Existing)
        const res = await fetch(FORWARD_CSV_URL, { cache: "no-store" });
        if (!res.ok) throw new Error(`Forward CSV fetch failed`);
        const text = await res.text();
        const parsed = Papa.parse(text, { skipEmptyLines: true });
        const rows = parsed.data;
        if (!rows || rows.length < 2) throw new Error("CSV has no data rows.");

        const headers = rows[0];
        const titles = headers.slice(1).map(t => String(t ?? "").trim()).filter(Boolean);
        const dataRows = rows.slice(1);
        const tenors = dataRows.map(r => String(r[0] ?? "").trim()).filter(Boolean);

        titles.forEach((title, i) => {
          const values = dataRows.map(r => toNumber(r[i + 1]));
          const front = firstFinite(values);
          const back = lastFinite(values);
          const spread = (front !== null && back !== null) ? (back - front) : null;
          const tail = lastStepDelta(values);
          const avg = avgSlopePerStep(values);
          const mm = minMax(values);
          const rangeText = (mm.min !== null && mm.max !== null) ? `$${fmtUSD(mm.min)} to $${fmtUSD(mm.max)}` : "—";

          const card = document.createElement("div");
          card.className = "card forwardCurve";
          const titleRow = document.createElement("div");
          titleRow.className = "titleRow";
          const h = document.createElement("div");
          h.className = "title";
          h.textContent = title.trim();
          titleRow.appendChild(h);

          const meta = document.createElement("div");
          meta.className = "meta";
          meta.textContent = (spread === null) ? "" : (spread > 0 ? "Contango" : (spread < 0 ? "Backwardation" : "Flat"));
          titleRow.appendChild(meta);
          card.appendChild(titleRow);

          // const canvas = document.createElement("canvas");
          // card.appendChild(canvas);

          // start

          const canvas = document.createElement("canvas");
          const box = document.createElement("div");
          box.className = "fcChartBox";
          box.appendChild(canvas);

          card.appendChild(box);

          //end

          const metrics = document.createElement("div");
          metrics.className = "metrics";
          metrics.appendChild(pill("Front (near)", front !== null ? `$${fmtUSD(front)}` : "—", "neu"));
          metrics.appendChild(pill("Back (far)", back !== null ? `$${fmtUSD(back)}` : "—", "neu"));
          metrics.appendChild(pill("Back–Front", spread !== null ? `$${fmtSignedUSD(spread)}` : "—", cls(spread)));
          metrics.appendChild(pill("Avg slope / qtr", avg !== null ? `$${fmtSignedUSD(avg)}` : "—", cls(avg)));
          metrics.appendChild(pill("Tail slope / qtr", tail !== null ? `$${fmtSignedUSD(tail)}` : "—", cls(tail)));
          metrics.appendChild(pill("Range", rangeText, "neu"));
          card.appendChild(metrics);
          chartsEl.appendChild(card);

          const fcChart = new Chart(canvas, {
            type: "line",
            data: {
              labels: tenors,
              datasets: [{
                data: values,
                borderColor: getCss("--accent"),
                backgroundColor: getCss("--accentFill"),
                borderWidth: 2,
                tension: 0.25,
                fill: true,
                pointRadius: 3,
                pointHoverRadius: 7,
                pointHitRadius: 6
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              interaction: { mode: "index", axis: "x", intersect: false },
              plugins: {
                legend: { display: false },
                tooltip: {
                  enabled: true,
                  padding: 16,
                  caretPadding: 12,
                  cornerRadius: 10,
                  boxPadding: 6,
                  bodySpacing: 6,
                  titleFont: { size: 14, weight: "600" },
                  bodyFont: { size: 14 },
                  displayColors: false,
                  callbacks: {
                    title: (items) => items?.[0]?.label ?? "",
                    label: (ctx) => ` $${fmtUSD(ctx.parsed.y)} / day`
                  }
                }
              },
              scales: {
                x: {
                  grid: { color: getCss("--grid") },
                  ticks: { maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
                },
                y: {
                  grid: { color: getCss("--grid") },
                  ticks: { callback: (val) => "$" + fmtUSD(val) },
                  title: { display: true, text: "USD/day" }
                }
              }
            }
          });

          // iOS/WebKit: ensure Chart.js recalculates after final layout
          requestAnimationFrame(() => {
            fcChart.resize();
            requestAnimationFrame(() => fcChart.resize());
          });

        });

        // Finish status last, once all charts are created
        await new Promise(r => requestAnimationFrame(() => requestAnimationFrame(r)));

        setStatus(`Data loaded.`);
        const sheetDate = await loadLastUpdatedFromSheet();
        lastUpdatedEl.textContent = sheetDate
          ? `Last updated: ${sheetDate}`
          : "Last updated: —";


      } catch (err) {
        console.error(err);
        setStatus("Error: " + (err && err.message ? err.message : String(err)), true);
      }
    }

    init();

</body>

</html>
